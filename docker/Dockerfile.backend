# syntax=docker/dockerfile:1.6
ARG PYTHON_VERSION=3.11
ARG NODE_VERSION=22
ARG PYPI_INDEX_URL=""
ARG APT_MIRROR=""

############################
# Backend build
############################
FROM python:${PYTHON_VERSION}-bookworm AS backend-build

ARG PYPI_INDEX_URL=""
ARG APT_MIRROR=""

WORKDIR /opt/xagent

# Use APT mirror if provided (for faster downloads in China)
RUN if [ -n "$APT_MIRROR" ]; then \
        sed -i "s|http://deb.debian.org/debian|$APT_MIRROR|g" /etc/apt/sources.list.d/debian.sources \
        || sed -i "s|http://deb.debian.org/debian|$APT_MIRROR|g" /etc/apt/sources.list; \
    fi

RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    gcc \
    git \
    pkg-config \
    python3-dev \
    curl \
    libgl1 \
    libglib2.0-0 \
    libsm6 \
    libxrender1 \
    libxext6 \
    && git config --global http.version HTTP/1.1 \
    && git config --global http.postBuffer 524288000 \
    && rm -rf /var/lib/apt/lists/*

# Copy dependency files first for better layer caching
COPY pyproject.toml .
COPY README.md .

# Copy .git directory for version detection (hatch-vcs)
COPY .git .git

# Create venv and install build tools
RUN python -m venv /opt/venv \
    && /opt/venv/bin/pip install --no-cache-dir ${PYPI_INDEX_URL:+--index-url $PYPI_INDEX_URL} --upgrade pip

# Install torch CPU version first (to avoid CUDA version from docling dependency)
RUN /opt/venv/bin/pip install --no-cache-dir --extra-index-url https://download.pytorch.org/whl/cpu torch

# Copy source code (changes frequently)
COPY src ./src
COPY alembic.ini .

# Install app + deepdoc into venv
RUN /opt/venv/bin/pip install --no-cache-dir ${PYPI_INDEX_URL:+--index-url $PYPI_INDEX_URL} . \
    && git clone https://github.com/xorbitsai/deepdoc-lib /opt/xagent/deepdoc-lib \
    && cd /opt/xagent/deepdoc-lib && git checkout fe75bbb676b141a1ea4257b198f6a04a89e5ac5c \
    && /opt/venv/bin/pip install --no-cache-dir ${PYPI_INDEX_URL:+--index-url $PYPI_INDEX_URL} /opt/xagent/deepdoc-lib \
    && rm -rf /opt/xagent/deepdoc-lib .git

############################
# Runtime
############################
FROM python:${PYTHON_VERSION}-bookworm AS runtime

ARG NODE_VERSION=22
ARG APT_MIRROR=""
ENV PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
ENV VIRTUAL_ENV=/opt/venv
ENV PATH="/opt/venv/bin:$PATH"

WORKDIR /opt/xagent

# Use APT mirror if provided (for faster downloads in China)
RUN if [ -n "$APT_MIRROR" ]; then \
        sed -i "s|http://deb.debian.org/debian|$APT_MIRROR|g" /etc/apt/sources.list.d/debian.sources \
        || sed -i "s|http://deb.debian.org/debian|$APT_MIRROR|g" /etc/apt/sources.list; \
    fi

# System deps + Node.js + LibreOffice + Playwright dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    gnupg \
    libreoffice \
    libglib2.0-0 \
    libsm6 \
    libxrender1 \
    libxext6 \
    libgl1 \
    libatk1.0-0 \
    libatk-bridge2.0-0 \
    libcups2 \
    libdbus-1-3 \
    libdrm2 \
    libxkbcommon0 \
    libxcomposite1 \
    libxdamage1 \
    libxfixes3 \
    libxi6 \
    libxtst6 \
    libpango-1.0-0 \
    libcairo2 \
    libgbm1 \
    libnss3 \
    libnspr4 \
    libxrandr2 \
    libasound2 \
    libpangocairo-1.0-0 \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js
RUN curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /usr/share/keyrings/nodesource.gpg \
    && echo "deb [signed-by=/usr/share/keyrings/nodesource.gpg] https://deb.nodesource.com/node_${NODE_VERSION}.x nodistro main" \
        > /etc/apt/sources.list.d/nodesource.list \
    && apt-get update \
    && apt-get install -y --no-install-recommends nodejs \
    && rm -rf /var/lib/apt/lists/*

# Copy entrypoint script early (changes rarely)
COPY docker/entrypoint.sh /opt/xagent/deploy/entrypoint.sh

# Copy venv + app (exclude .git directory)
COPY --from=backend-build /opt/venv /opt/venv
COPY --from=backend-build /opt/xagent/src /opt/xagent/src
COPY --from=backend-build /opt/xagent/pyproject.toml /opt/xagent/
COPY --from=backend-build /opt/xagent/alembic.ini /opt/xagent/

# Copy frontend package files for npm tasks (e.g., PPTX generation)
COPY frontend/package.json frontend/package-lock.json /opt/xagent/frontend/
RUN cd /opt/xagent/frontend && npm ci \
    && npm install -g pptxgenjs@4.0.1 \
    && python -m playwright install chromium \
    && python -c "import nltk; nltk.download('punkt'); nltk.download('punkt_tab'); nltk.download('wordnet'); nltk.download('averaged_perceptron_tagger')" \
    && python -c "import tiktoken; tiktoken.encoding_for_model('gpt-4')" \
    && chmod +x /opt/xagent/deploy/entrypoint.sh

EXPOSE 8000
ENTRYPOINT ["/opt/xagent/deploy/entrypoint.sh"]
